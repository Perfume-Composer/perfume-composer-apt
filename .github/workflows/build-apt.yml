name: Build & Publish APT repo

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS support)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: git lfs pull

      - name: Install apt-utils
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev gnupg rsync tree

      - name: Import GPG private key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format=long

      - name: Prepare repo structure
        run: |
          mkdir -p public/dists/stable/main/binary-amd64
          mkdir -p public/pool/main/p/perfume-composer

          echo "üì¶ Copying Debian .deb packages into public/pool..."
          cp -v pool/main/p/perfume-composer/*.deb public/pool/main/p/perfume-composer/

          echo "üóÇÔ∏è Building APT indexes..."
          cd public
          
          apt-ftparchive packages ./pool > dists/stable/main/binary-amd64/Packages
          gzip -kf dists/stable/main/binary-amd64/Packages

          # ‚úÖ Initial Release header
          cat > dists/stable/Release <<'EOF'
          Origin: Perfume Composer
          Label: Perfume Composer
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: Perfume Composer APT repository
          Date: $(date -Ru)
          EOF
          
          apt-ftparchive release dists/stable >> dists/stable/Release
          cd -

      - name: Generate and include AppStream DEP-11 metadata
        run: |
          echo "üß© Generating DEP-11 metadata for Software Manager..."
          mkdir -p public/dists/stable/main/dep11
      
          cp appstream/perfume-composer.xml.gz public/dists/stable/main/dep11/perfume-composer.xml.gz
      
          gzip -d appstream/perfume-composer.xml.gz
          appstreamcli convert appstream/perfume-composer.xml public/dists/stable/main/dep11/Components-amd64.yml
          gzip -f public/dists/stable/main/dep11/Components-amd64.yml
          gzip -f appstream/perfume-composer.xml
      
          echo "‚úÖ DEP-11 generated at public/dists/stable/main/dep11/Components-amd64.yml.gz"

      - name: Rebuild Release metadata (preserve Suite/Codename)
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "üîÅ Rebuilding Release metadata (safe mode)..."
          cd public

          # --- Write explicit header again ---
          cat > dists/stable/Release <<EOF
          Origin: Perfume Composer
          Label: Perfume Composer
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: Perfume Composer APT repository
          Date: $(date -Ru)
          EOF

          # --- Append checksum sections ---
          apt-ftparchive release dists/stable >> dists/stable/Release

          # --- Guarantee presence of Suite/Codename ---
          if ! grep -q "^Suite:" dists/stable/Release; then echo "Suite: stable" >> dists/stable/Release; fi
          if ! grep -q "^Codename:" dists/stable/Release; then echo "Codename: stable" >> dists/stable/Release; fi

          # --- Re-sign Release and InRelease safely ---
          echo "$GPG_PASSPHRASE" | \
            gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 \
            -abs -o dists/stable/Release.gpg dists/stable/Release

          echo "$GPG_PASSPHRASE" | \
            gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 \
            --clearsign -o dists/stable/InRelease dists/stable/Release

          cd -


      - name: Patch AppStream metadata (add developer and content rating)
        run: |
          echo "üß© Patching AppStream metadata..."
          META_XML="appstream/perfume-composer.xml"
          if [ -f "appstream/perfume-composer.xml.gz" ]; then
            gzip -d appstream/perfume-composer.xml.gz
          fi
          if grep -q "<component" "$META_XML"; then
            if ! grep -q "<developer" "$META_XML"; then
              sed -i '/<name>Perfume Composer<\/name>/a \
              <developer id="io.github.perfume-composer">\
              <name>Perfume Composer Team</name>\
              </developer>\
              <content_rating type="oars-1.1" />' "$META_XML"
            fi
          fi
          gzip -f "$META_XML"
          sudo apt-get install -y appstream || true
          appstreamcli validate appstream/perfume-composer.xml.gz || true

      - name: Debug repository contents
        run: |
          echo "ü™û Showing repository structure:"
          tree -L 5 public || ls -R public
          echo
          echo "üîë Checking GPG keys:"
          gpg --list-secret-keys || true
          echo
          echo "üß© Debian package files found:"
          find . -type f -name "*.deb" || true

      - name: Sign Release
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          cd public/dists/stable
          echo "$GPG_PASSPHRASE" | \
            gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback \
            -abs -o Release.gpg Release
          echo "$GPG_PASSPHRASE" | \
            gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback \
            --clearsign -o InRelease Release
          cd -

      - name: Include public key
        run: cp PERFUME-COMPOSER.gpg.key public/

      - name: Auto-tag new version and update changelog
        run: |
          echo "üßæ Checking for new version..."
          VERSION=$(basename public/pool/main/p/perfume-composer/PerfumeComposer_*.deb | sed 's/PerfumeComposer_\(.*\)\.deb/\1/')
          echo "Detected version: $VERSION"
          if [ -z "$VERSION" ]; then
            echo "No version detected. Skipping tagging."
            exit 0
          fi
          if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION$"; then
            echo "‚úÖ Tag v$VERSION already exists on remote. Skipping tag creation and push."
            exit 0
          fi
          DATE=$(date -u +"%Y-%m-%d")
          echo -e "## v$VERSION ‚Äî $DATE\n- $(git log -1 --pretty=%s)\n" | cat - CHANGELOG.md > temp && mv temp CHANGELOG.md
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "Update changelog for v$VERSION" || echo "No changelog updates."
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"


      - name: Generate index.html for GitHub Pages
        run: |
          echo "üåê Generating index.html..."
          mkdir -p public
          VERSION=$(find pool -type f -iname "PerfumeComposer_*.deb" -printf "%f\n" | head -n 1 | sed 's/PerfumeComposer_\(.*\)\.deb/\1/')
          if [ -z "$VERSION" ]; then
            echo "‚ùå Could not detect version ‚Äî no .deb found!"
            ls pool/main/p/perfume-composer
            exit 1
          fi

          # Detect if Windows installer exists
          if [ -f "windows/PerfumeComposerSetup_${VERSION}.exe" ]; then
            WIN_LINK="<p>üíª <a href=\"windows/PerfumeComposerSetup_${VERSION}.exe\">‚¨áÔ∏è Download for Windows (.exe)</a></p>"
          else
            WIN_LINK="<p>üíª <em>Windows installer not yet available</em></p>"
          fi

          # --- Create HTML ---
          cat > public/index.html <<HTML
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Perfume Composer APT Repository</title>
            <style>
              body { font-family: Arial, sans-serif; background: #0b0b0b; color: #eaeaea; line-height: 1.6; padding: 2rem; }
              h1 { color: #a7e3ff; text-shadow: 0 0 5px #1e90ff; }
              code, pre { background: #222; color: #9effa8; padding: 0.3rem 0.5rem; border-radius: 5px; }
              a { color: #9ecbff; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .card { background: #141414; padding: 1rem 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; box-shadow: 0 0 10px #000; }
              img { max-width: 600px; width: 100%; border-radius: 10px; margin-top: 1rem; }
            </style>
          </head>
          <body>
            <h1>üåø Perfume Composer APT Repository</h1>
            <div class="card">
              <h2>Latest Release</h2>
              <p><strong>Version:</strong> VERSION_PLACEHOLDER</p>
              <p>üêß <a href="pool/main/p/perfume-composer/PerfumeComposer_VERSION_PLACEHOLDER.deb">‚¨áÔ∏è Download for Linux (.deb)</a></p>
              ${WIN_LINK}
              <img src="screenshots/professional-perfume-composer.png" alt="Perfume Composer Screenshot">
            </div>
            <div class="card">
              <h2>Install via APT</h2>
              <p>üí° Quick one-liner install:</p>
              <pre><code>bash &lt;(curl -fsSL https://perfume-composer.github.io/perfume-composer-apt/install.sh)</code></pre>
              <p>Or manual installation steps:</p>
              <pre><code>curl -fsSL https://perfume-composer.github.io/perfume-composer-apt/PERFUME-COMPOSER.gpg.key | \
            sudo gpg --dearmor -o /usr/share/keyrings/perfume-composer.gpg
            
            echo "deb [signed-by=/usr/share/keyrings/perfume-composer.gpg] \
            https://perfume-composer.github.io/perfume-composer-apt stable main" | \
            sudo tee /etc/apt/sources.list.d/perfume-composer.list > /dev/null
            
            sudo apt update
            sudo apt install perfumecomposer
              </code></pre>
            </div>

            <div class="card">
              <h2>About</h2>
              <p>Perfume Composer is a professional fragrance composition and IFRA compliance tool for perfumers.</p>
              <p>Maintained by <strong>Perfume Composer Team</strong> ‚Äî crafted with care by Chris and Paul üß™</p>
            </div>
          </body>
          </html>
          HTML

          # --- Replace placeholders ---
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" public/index.html


      - name: Prepare GitHub Pages content
        run: |
          echo "üß© Preparing content for GitHub Pages..."
          mkdir -p public
      
          if [ -d "pool" ] && [ ! -d "public/pool" ]; then
            cp -r pool public/
          fi
          if [ -d "appstream" ] && [ ! -d "public/appstream" ]; then
            cp -r appstream public/
          fi
          if [ -d "windows" ]; then
            cp -r windows public/
            echo "üíª Copied Windows installers to public/"
          fi      
          if [ -d "screenshots" ]; then
            cp -r screenshots public/
            echo "üñºÔ∏è  Copied screenshots to public/"
          fi
      
          if [ -f "public/index.html" ]; then
            echo "‚úÖ index.html found in public/"
          elif [ -f "index.html" ]; then
            cp index.html public/
            echo "‚úÖ index.html copied to public/"
          else
            echo "‚ö†Ô∏è  index.html not found anywhere!"
          fi
      
          echo "üßæ Verifying final public/ contents..."
          tree -L 3 public || ls -R public

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
