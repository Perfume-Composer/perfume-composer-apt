name: Build & Publish APT repo

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS support)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: git lfs pull

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev gnupg rsync appstream tree

      - name: Import GPG private key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format=long

      # --------------------------------------------
      # STEP 1 ‚Äî BUILD APT STRUCTURE
      # --------------------------------------------
      - name: Build APT structure
        run: |
          echo "üìÅ Preparing repository structure..."
          mkdir -p dists/stable/main/binary-amd64
          mkdir -p pool/main/p/perfume-composer

          echo "üì¶ Checking .deb packages..."
          if compgen -G "PerfumeComposer_*.deb" > /dev/null; then
            echo "‚úÖ Found .deb at root ‚Äî copying to pool/"
            cp -u PerfumeComposer_*.deb pool/main/p/perfume-composer/
          else
            echo "‚ö†Ô∏è  No .deb file found at repo root."
          fi

          echo "üßæ Generating Packages index..."
          cd pool/main/p/perfume-composer
          dpkg-scanpackages . /dev/null | gzip -9c > ../../../../../dists/stable/main/binary-amd64/Packages.gz
          cd ../../../../../
          echo "‚úÖ Packages.gz built successfully"

      # --------------------------------------------
      # STEP 2 ‚Äî GENERATE APPSTREAM (DEP-11)
      # --------------------------------------------
      - name: Generate DEP-11 AppStream metadata
        run: |
          echo "üß© Generating DEP-11 metadata..."
          mkdir -p dists/stable/main/dep11

          cp appstream/perfume-composer.xml.gz dists/stable/main/dep11/perfume-composer.xml.gz
          gzip -df appstream/perfume-composer.xml.gz || true
          appstreamcli convert appstream/perfume-composer.xml dists/stable/main/dep11/Components-amd64.yml
          gzip -f dists/stable/main/dep11/Components-amd64.yml
          gzip -f appstream/perfume-composer.xml || true

          echo "‚úÖ DEP-11 generated at dists/stable/main/dep11/Components-amd64.yml.gz"

      # --------------------------------------------
      # STEP 3 ‚Äî CREATE RELEASE METADATA & SIGN
      # --------------------------------------------
      - name: Build Release file and sign
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "üßæ Building and signing Release..."
          cat > dists/stable/Release <<EOF
          Origin: Perfume Composer
          Label: Perfume Composer
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: Perfume Composer APT repository
          Date: $(date -Ru)
          EOF

          apt-ftparchive release dists/stable >> dists/stable/Release

          echo "$GPG_PASSPHRASE" | \
            gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 \
            -abs -o dists/stable/Release.gpg dists/stable/Release

          echo "$GPG_PASSPHRASE" | \
            gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 \
            --clearsign -o dists/stable/InRelease dists/stable/Release

          echo "‚úÖ Release metadata signed."

      # --------------------------------------------
      # STEP 4 ‚Äî COPY KEY AND WINDOWS INSTALLER
      # --------------------------------------------
      - name: Copy GPG key and Windows installer
        run: |
          mkdir -p public
          cp PERFUME-COMPOSER.gpg.key public/
          cp -r pool dists appstream public/
          if [ -d "windows" ]; then
            cp -r windows public/
          fi

      # --------------------------------------------
      # STEP 5 ‚Äî GENERATE INDEX.HTML
      # --------------------------------------------
      - name: Generate index.html
        run: |
          echo "üåê Generating index.html..."
          VERSION=$(find pool -type f -iname "PerfumeComposer_*.deb" -printf "%f\n" | head -n 1 | sed 's/PerfumeComposer_\(.*\)\.deb/\1/')
          WIN_LINK=""
          if [ -f "windows/PerfumeComposerSetup_${VERSION}.exe" ]; then
            WIN_LINK="<p>üíª <a href=\"windows/PerfumeComposerSetup_${VERSION}.exe\">‚¨áÔ∏è Download for Windows (.exe)</a></p>"
          else
            WIN_LINK="<p>üíª <em>Windows installer not available</em></p>"
          fi

          cat > public/index.html <<HTML
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Perfume Composer APT Repository</title>
            <style>
              body { font-family: Arial, sans-serif; background: #0b0b0b; color: #eaeaea; line-height: 1.6; padding: 2rem; }
              h1 { color: #a7e3ff; text-shadow: 0 0 5px #1e90ff; }
              code, pre { background: #222; color: #9effa8; padding: 0.3rem 0.5rem; border-radius: 5px; }
              a { color: #9ecbff; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .card { background: #141414; padding: 1rem 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; box-shadow: 0 0 10px #000; }
              img { max-width: 600px; width: 100%; border-radius: 10px; margin-top: 1rem; }
            </style>
          </head>
          <body>
            <h1>üåø Perfume Composer APT Repository</h1>
            <div class="card">
              <h2>Latest Release</h2>
              <p><strong>Version:</strong> ${VERSION}</p>
              <p>üêß <a href="pool/main/p/perfume-composer/PerfumeComposer_${VERSION}.deb">‚¨áÔ∏è Download for Linux (.deb)</a></p>
              ${WIN_LINK}
              <img src="appstream/screenshots/professional-perfume-composer.png" alt="Perfume Composer Screenshot">
            </div>

            <div class="card">
              <h2>Install via APT</h2>
              <pre><code>bash &lt;(curl -fsSL https://perfume-composer.github.io/perfume-composer-apt/install.sh)</code></pre>
            </div>

            <div class="card">
              <h2>About</h2>
              <p>Perfume Composer is a professional fragrance composition and IFRA compliance tool for perfumers.</p>
              <p>Maintained by <strong>Perfume Composer Team</strong> ‚Äî crafted with care by Chris and Paul üß™</p>
            </div>
          </body>
          </html>
          HTML
          echo "‚úÖ index.html created in public/"

      # --------------------------------------------
      # STEP 6 ‚Äî DEPLOY TO GITHUB PAGES
      # --------------------------------------------
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
