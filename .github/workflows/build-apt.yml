name: Build & Publish APT repo

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (with LFS support)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS files
        run: git lfs pull

      - name: Install APT tools
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev gnupg appstream rsync tree

      - name: Import GPG private key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format=long

      - name: Prepare repository structure
        run: |
          echo "üìÅ Preparing repository structure..."
          mkdir -p dists/stable/main/binary-amd64
          mkdir -p pool/main/p/perfume-composer
          
          echo "üì¶ Checking .deb packages..."
          if compgen -G "PerfumeComposer_*.deb" > /dev/null; then
            echo "‚úÖ Found .deb at root ‚Äî copying to pool/"
            cp -u PerfumeComposer_*.deb pool/main/p/perfume-composer/
          elif compgen -G "pool/main/p/perfume-composer/PerfumeComposer_*.deb" > /dev/null; then
            echo "üì¶ .deb already present inside pool ‚Äî skipping copy."
          else
            echo "‚ùå No .deb file found anywhere!"
            exit 1
          fi

          echo "üßæ Generating Packages..."
          dpkg-scanpackages pool/main/p/perfume-composer > dists/stable/main/binary-amd64/Packages
          gzip -kf dists/stable/main/binary-amd64/Packages

          echo "üìú Creating Release file..."
          cat > dists/stable/Release <<EOF
          Origin: Perfume Composer
          Label: Perfume Composer
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: Perfume Composer APT repository
          Date: $(date -Ru)
          EOF

          apt-ftparchive release dists/stable >> dists/stable/Release

      - name: Generate AppStream DEP-11 metadata
        run: |
          echo "üß© Generating DEP-11 metadata for Software Manager..."
          mkdir -p dists/stable/main/dep11

          cp appstream/perfume-composer.xml.gz dists/stable/main/dep11/
          cp appstream/Components-amd64.yml.gz dists/stable/main/dep11/

          echo "‚úÖ DEP-11 files placed in dists/stable/main/dep11"

      - name: Sign repository Release files
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "üîè Signing Release files..."
          cd dists/stable
          echo "$GPG_PASSPHRASE" | \
            gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 \
            -abs -o Release.gpg Release
          echo "$GPG_PASSPHRASE" | \
            gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 \
            --clearsign -o InRelease Release
          cd ../..

      - name: Include public key
        run: cp PERFUME-COMPOSER.gpg.key dists/stable/

      - name: Generate index.html for GitHub Pages
        run: |
          VERSION=$(find pool/main/p/perfume-composer -type f -iname "PerfumeComposer_*.deb" | head -n 1 | sed 's/.*PerfumeComposer_\(.*\)\.deb/\1/')
          echo "üåê Generating index.html for version $VERSION..."
          cat > index.html <<HTML
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>Perfume Composer Repository</title>
            <style>
              body { font-family: Arial, sans-serif; background:#0b0b0b; color:#eaeaea; line-height:1.6; padding:2rem; }
              h1 { color:#a7e3ff; text-shadow:0 0 5px #1e90ff; }
              code, pre { background:#222; color:#9effa8; padding:0.3rem 0.5rem; border-radius:5px; }
              a { color:#9ecbff; text-decoration:none; }
              a:hover { text-decoration:underline; }
            </style>
          </head>
          <body>
            <h1>üåø Perfume Composer APT Repository</h1>
            <p><strong>Version:</strong> $VERSION</p>
            <p>üêß <a href="pool/main/p/perfume-composer/PerfumeComposer_${VERSION}.deb">Download for Linux (.deb)</a></p>
            <p>üíª <a href="windows/PerfumeComposerSetup_${VERSION}.exe">Download for Windows (.exe)</a></p>
            <h2>Install via APT</h2>
            <p>üí° Quick one-liner:</p>
            <pre><code>bash &lt;(curl -fsSL https://perfume-composer.github.io/perfume-composer-apt/install.sh)</code></pre>
            <p>Or manual setup:</p>
            <pre><code>curl -fsSL https://perfume-composer.github.io/perfume-composer-apt/PERFUME-COMPOSER.gpg.key | sudo gpg --dearmor -o /usr/share/keyrings/perfume-composer.gpg
            echo "deb [signed-by=/usr/share/keyrings/perfume-composer.gpg] https://perfume-composer.github.io/perfume-composer-apt stable main" | sudo tee /etc/apt/sources.list.d/perfume-composer.list
            sudo apt update
            sudo apt install perfumecomposer</code></pre>
          </body>
          </html>
          HTML

      - name: Prepare GitHub Pages content
        run: |
          echo "üì¶ Preparing content for GitHub Pages..."
          mkdir -p public
          cp -r dists pool appstream windows docs PERFUME-COMPOSER.gpg.key index.html install.sh public/
          echo "‚úÖ Repository content copied to public/"
          tree -L 3 public

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
