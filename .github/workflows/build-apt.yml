name: Build & Publish APT repo

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # âœ… Add this block to enable Git LFS in the runner
      - name: Enable Git LFS
        run: |
          git lfs install
          git lfs fetch
          git lfs pull

      - name: Install apt-utils
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev gnupg rsync

      - name: Import GPG private key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format=long

      - name: Prepare repo structure
        run: |
          mkdir -p public/dists/stable/main/binary-amd64
          mkdir -p public/pool
          # Copy Debian pool
          rsync -a pool/ public/pool/
          # âœ… Copy screenshots for AppStream / website
          mkdir -p public/screenshots
          rsync -a screenshots/ public/screenshots/ || true

          # Build Packages index
          apt-ftparchive packages public/pool > public/dists/stable/main/binary-amd64/Packages
          gzip -kf public/dists/stable/main/binary-amd64/Packages

          # Build Release file
          cat > public/dists/stable/Release << 'EOF'
          Origin: Perfume Composer
          Label: Perfume Composer
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: Perfume Composer APT repository
          EOF
          apt-ftparchive release public/dists/stable >> public/dists/stable/Release

      - name: Sign Release
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          cd public/dists/stable
          echo "$GPG_PASSPHRASE" | \
            gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback \
            -abs -o Release.gpg Release
          echo "$GPG_PASSPHRASE" | \
            gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback \
            --clearsign -o InRelease Release
          cd -

      - name: Include public key
        run: cp PERFUME-COMPOSER.gpg.key public/
        
      - name: Auto-tag new version and update changelog
        run: |
          echo "ðŸ§¾ Checking for new version..."
          VERSION=$(basename pool/main/p/perfume-composer/PerfumeComposer_*.deb | sed 's/PerfumeComposer_\(.*\)\.deb/\1/')
          echo "Detected version: $VERSION"

          if [ -n "$VERSION" ]; then
            echo "Updating CHANGELOG.md..."
            DATE=$(date -u +"%Y-%m-%d")
            echo -e "## v$VERSION â€” $DATE\n- $(git log -1 --pretty=%s)\n" | cat - CHANGELOG.md > temp && mv temp CHANGELOG.md
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add CHANGELOG.md
            git commit -m "Update changelog for v$VERSION" || echo "No changelog updates."
            git tag -a "v$VERSION" -m "Release v$VERSION"
            git push origin "v$VERSION"
          else
            echo "No version detected."
          fi   

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
