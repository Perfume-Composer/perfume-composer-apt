name: Build & Publish APT repo

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gnupg appstream rsync tree

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mkdir -p ~/.gnupg && chmod 700 ~/.gnupg
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format=long
          echo "‚úÖ GPG key imported"

      # -------------------------------------------------------------
      #  Build Debian repo indexes (no "public/" folder anymore)
      # -------------------------------------------------------------
      - name: Build APT structure
        run: |
          mkdir -p dists/stable/main/binary-amd64
          mkdir -p pool/main/p/perfume-composer

          echo "üì¶ Moving Debian packages..."
          find . -type f -name "PerfumeComposer_*.deb" -exec mv {} pool/main/p/perfume-composer/ \; || true
          ls -l pool/main/p/perfume-composer/ || true

          echo "üßæ Generating Packages..."
          cd pool/main/p/perfume-composer
          dpkg-scanpackages . /dev/null | gzip -9c > ../../../dists/stable/main/binary-amd64/Packages.gz
          cd ../../../../
          echo "‚úÖ Packages.gz built"

      # -------------------------------------------------------------
      #  Generate AppStream metadata (DEP-11)
      # -------------------------------------------------------------
      - name: Generate AppStream DEP-11 metadata
        run: |
          echo "ü™∂ Generating AppStream metadata..."
          bash update_appstream.sh
          echo "‚úÖ AppStream/DEP-11 done."

      # -------------------------------------------------------------
      #  Create signed Release + InRelease
      # -------------------------------------------------------------
      - name: Sign Release file
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "üîè Creating signed Release..."
          RELEASE_FILE="dists/stable/main/Release"
          VERSION=$(basename pool/main/p/perfume-composer/PerfumeComposer_*.deb | sed 's/PerfumeComposer_\(.*\)\.deb/\1/')
          cat > "$RELEASE_FILE" <<EOF
          Origin: Perfume Composer
          Label: Perfume Composer APT
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: Perfume Composer APT repository
          Version: ${VERSION:-1.0.0}
          EOF
          cd dists/stable/main
          gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" -abs -o Release.gpg Release
          gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --clearsign -o InRelease Release
          cd ../../../
          echo "‚úÖ Release signed successfully"

      # -------------------------------------------------------------
      #  Generate index.html for GitHub Pages (direct at root)
      # -------------------------------------------------------------
      - name: Generate index.html
        run: |
          echo "üåê Generating index.html..."
          VERSION=$(basename pool/main/p/perfume-composer/PerfumeComposer_*.deb | sed 's/PerfumeComposer_\(.*\)\.deb/\1/')
          WIN_PATH="windows/PerfumeComposerSetup_${VERSION}.exe"
          if [ -f "$WIN_PATH" ]; then
            WIN_LINK="<p>üíª <a href=\"${WIN_PATH}\">‚¨áÔ∏è Download for Windows (.exe)</a></p>"
          else
            WIN_LINK="<p><em>Windows installer not available yet.</em></p>"
          fi

          cat > index.html <<HTML
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>Perfume Composer APT Repository</title>
            <style>
              body { background: #0c0c0c; color: #eee; font-family: system-ui; padding: 2rem; line-height: 1.6; }
              h1 { color: #82d4ff; }
              code { background: #222; padding: 0.2rem 0.4rem; border-radius: 4px; }
              .card { background: #141414; padding: 1rem 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; }
              a { color: #9ecbff; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>üåø Perfume Composer APT Repository</h1>
            <div class="card">
              <h2>Latest Version</h2>
              <p><strong>${VERSION}</strong></p>
              <p>üêß <a href="pool/main/p/perfume-composer/PerfumeComposer_${VERSION}.deb">‚¨áÔ∏è Download for Linux (.deb)</a></p>
              ${WIN_LINK}
              <img src="appstream/screenshots/professional-perfume-composer.png" alt="Screenshot" width="600">
            </div>
            <div class="card">
              <h2>Install via APT</h2>
              <pre><code>bash &lt;(curl -fsSL https://perfume-composer.github.io/perfume-composer-apt/install.sh)</code></pre>
            </div>
          </body>
          </html>
          HTML

      # -------------------------------------------------------------
      #  Deploy everything directly (root = GitHub Pages)
      # -------------------------------------------------------------
      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    needs: build
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
