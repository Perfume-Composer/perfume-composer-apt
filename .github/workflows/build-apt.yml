name: Build & Publish APT + Windows Repo

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Initialize Git LFS
        run: |
          echo "üîß Setting up Git LFS..."
          git lfs install
          git lfs track "*.exe"
          git lfs track "*.deb"
          git add .gitattributes
          git commit -m "chore: ensure LFS tracking for .exe and .deb" || true
          git push || true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gnupg rsync appstream tree

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mkdir -p ~/.gnupg && chmod 700 ~/.gnupg
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG

      - name: Clean old versions from pool before upload
        run: |
          echo "üßΩ Removing old .deb packages..."
          find pool/main/p/perfume-composer/ -type f -name "PerfumeComposer_*.deb" \
          -not -name "$(basename $(ls -t pool/main/p/perfume-composer/PerfumeComposer_*.deb | head -n 1))" \
          -delete || true

      - name: Prepare repository structure
        run: |
          echo "üìÅ Preparing repository..."
          mkdir -p public/dists/stable/main/binary-amd64
          mkdir -p public/pool/main/p/perfume-composer
          mkdir -p public/windows
          mkdir -p public/appstream
          mkdir -p public/docs

          echo "üì¶ Copying content..."
          cp -v pool/main/p/perfume-composer/*.deb public/pool/main/p/perfume-composer/
          cp -v PERFUME-COMPOSER.gpg.key public/
          cp -v install.sh public/
          cp -r appstream/* public/appstream/
          cp -r docs/* public/docs/
          cp -r windows/* public/windows/

          echo "üßæ Generating Packages index..."
          cd public
          apt-ftparchive packages ./pool > dists/stable/main/binary-amd64/Packages
          gzip -kf dists/stable/main/binary-amd64/Packages

          cat > dists/stable/Release <<EOF
          Origin: Perfume Composer
          Label: Perfume Composer
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: Perfume Composer APT repository
          Date: $(date -Ru)
          EOF

          apt-ftparchive release dists/stable >> dists/stable/Release
          cd -

      - name: Generate DEP-11 metadata
        run: |
          echo "üß© Generating DEP-11 metadata..."
          mkdir -p public/dists/stable/main/dep11
          gzip -df appstream/perfume-composer.xml.gz || true
          appstreamcli convert appstream/perfume-composer.xml public/dists/stable/main/dep11/Components-amd64.yml
          gzip -f public/dists/stable/main/dep11/Components-amd64.yml
          gzip -f appstream/perfume-composer.xml
          echo "‚úÖ DEP-11 ready."

      - name: Sign Release files
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "üîè Signing Release..."
          cd public/dists/stable
          echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 -abs -o Release.gpg Release
          echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --clearsign -o InRelease Release
          cd -

      - name: Generate index.html
        run: |
          echo "üåê Generating index.html..."
          mkdir -p public
          VERSION=$(basename pool/main/p/perfume-composer/PerfumeComposer_*.deb | sed 's/PerfumeComposer_\(.*\)\.deb/\1/')

          if [ -f "windows/PerfumeComposerSetup_${VERSION}.exe" ]; then
            WIN_LINK="<p>üíª <a href=\"windows/PerfumeComposerSetup_${VERSION}.exe\">‚¨áÔ∏è Download for Windows (.exe)</a></p>"
          else
            WIN_LINK="<p>üíª <em>Windows installer not yet available</em></p>"
          fi

          cat > public/index.html <<HTML
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>Perfume Composer Repository</title>
            <style>
              body { background: #0b0b0b; color: #eaeaea; font-family: Arial; padding: 2rem; }
              h1 { color: #a7e3ff; }
              a { color: #8ecbff; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .card { background: #141414; padding: 1rem 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; }
              img { width: 100%; max-width: 600px; border-radius: 10px; margin-top: 1rem; }
              footer { text-align: center; margin-top: 3rem; font-size: 0.9em; color: #888; }
            </style>
          </head>
          <body>
            <h1>üåø Perfume Composer APT Repository</h1>
            <div class="card">
              <h2>Latest Version</h2>
              <p><strong>Version:</strong> ${VERSION}</p>
              <p><strong>Build date:</strong> $(date -u +"%Y-%m-%d")</p>
              <p>üêß <a href="pool/main/p/perfume-composer/PerfumeComposer_${VERSION}.deb">‚¨áÔ∏è Download for Linux (.deb)</a></p>
              ${WIN_LINK}
              <img src="appstream/screenshots/professional-perfume-composer.png" alt="Screenshot">
            </div>
            <div class="card">
              <h2>Install via APT</h2>
              <pre><code>bash &lt;(curl -fsSL https://perfume-composer.github.io/perfume-composer-apt/install.sh)</code></pre>
            </div>
            <footer>
              Maintained by the <strong>Perfume Composer Team</strong> ‚Äî crafted with üíú by Chris &amp; Paul
            </footer>
          </body>
          </html>
          HTML

      - name: Verify public folder
        run: |
          echo "üßæ Final check of repository contents:"
          tree -L 3 public || ls -R public

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
